<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BreezyEzy!</title>

  <!-- ========== SECURITY HEADERS (BROWSER GUARDRAILS) ========== -->
  <!-- Note: 'unsafe-inline' for scripts is needed because this file uses inline <script>. 
       If/when you move scripts into a separate .js file, you can remove 'unsafe-inline'
       and keep only "script-src 'self'". -->
  <meta http-equiv="Content-Security-Policy"
        content="
          default-src 'self';
          connect-src 'self' https://script.google.com https://*.googleusercontent.com;
          img-src 'self' https://lh3.googleusercontent.com data: https:;
          font-src https://fonts.gstatic.com;
          style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
          script-src 'self' 'unsafe-inline';
          media-src 'self' https:;
          frame-ancestors 'self';
          base-uri 'self';
          form-action 'self';
          upgrade-insecure-requests;
        ">
  <meta http-equiv="Referrer-Policy" content="no-referrer-when-downgrade">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="Permissions-Policy" content="camera=(), microphone=(), geolocation=(), payment=()">

  <!-- Google Font: Poetsen One (for brand title) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poetsen+One&display=swap" rel="stylesheet">

  <style>
    /* === (Your CSS unchanged except your existing content) === */
    :root{
      --icon-color-default:#ddeaef;
      --icon-color-active:#789cac;
      --shell:#85adb8;
      --fg:#FBFAF5;
      --chip-bg:#072a54;
      --chip-fg:#fff;
      --accent:#ef4444;

      --scroll-btn-size-desktop: 80px;
      --scroll-btn-size-mobile: 70px;
      --scroll-btn-right-desktop: calc((100% - 1200px) / 2 + 16px);
      --scroll-btn-right-mobile: 2px;
      --scroll-btn-bottom-desktop: 24px;
      --scroll-btn-bottom-mobile: 50px;

      /* Quickview (light) */
      --qv-bg:#ffffff;
      --qv-fg:#111827;
      --qv-muted:#666;
      --qv-border:#eee;
      --qv-panel:#f7f7f7;
      --qv-thumb-border:#789cac;
      /* Controls contrast (light) */
      --qv-ctl:#262c2f;
    }
    @media (prefers-color-scheme: dark){
      :root{
        --qv-bg:#1f2937;
        --qv-fg:#e5e7eb;
        --qv-muted:#a3a3a3;
        --qv-border:#374151;
        --qv-panel:#0b0f14;
        --qv-thumb-border:#93c5fd;
        --qv-ctl:#f8f9f9;
      }
    }

    body { font-family: Arial, sans-serif; margin: 0; background: var(--shell); }

    /* ===== (Everything below is your original CSS â€“ trimmed for length in this note)
       Keep all your existing CSS exactly as-is. I only changed security-related JS below. ===== */

    .site-shell{ position: sticky; top: 0; z-index: 20; background: var(--shell); box-shadow: none; }
    .shell-pad{ padding:10px 12px 3px; }
    .hero{ position:relative; height:clamp(160px, 28vw, 260px); max-width: 1200px; margin: 0 auto; border-radius:14px; overflow:visible; background-image:url("assets/images/Breezy%20Banner.png"); background-size:cover; background-position:center 30%; }
    .hero::before{ content:""; position:absolute; inset:0; background:linear-gradient(to bottom, rgba(0,0,0,.25), rgba(0,0,0,.25)); pointer-events:none; border-radius: inherit; }
    .banner-bar{ position:absolute; top:10px; left:12px; right:12px; display:flex; align-items:center; justify-content:space-between; gap:12px; z-index:5; }

    .cart-link { position: relative; display: inline-flex; align-items: center; gap: 0; padding: 0; }
    .cart-link img { width: 35px; height: 35px; display: block; }
    .cart-count { position: absolute; top: -4px; right: -4px; min-width: 20px; height: 20px; padding: 0 5px; background: #192a37; color: #f5f5f5 ; border: 2px solid #fcfcfc; border-radius: 999px; font-size: .8rem; line-height: 14px; display: flex; align-items: center; justify-content: center; font-weight: 600; pointer-events: none; box-shadow: 0 2px 6px rgba(0,0,0,.18); }
    @media (min-width:768px){ .cart-link img { width: 60px; height: 60px; } .cart-count { top: -7px; right: -5px; min-width: 10px; height: 20px; line-height: 18px; } .cart-link { margin-right: 8px; } }

    .brand-center { position: absolute; inset: 0; z-index: 2; display: flex; align-items: center; justify-content: center; text-align: center; color: var(--fg); padding: 0 12px; pointer-events: none; }
    @media (min-width: 768px){ .brand-center > div { transform: translateY(80px); } }
    .brand-title { margin: 0; line-height: 1.1; font-weight: 800; font-family: "Poetsen One", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; font-size: 45px; text-shadow: 0 2px 10px rgba(0,0,0,.35); }
    @media (max-width: 767.98px){ .brand-title { font-size: 32px; } .brand-center > div { transform: translateY(50px); } }
    .brand-subtitle{ margin:.35rem 0 0 0; opacity:.95; font-size:clamp(1rem, 3vw, 1.2rem); text-shadow:0 1px 6px rgba(0,0,0,.35); }
    @media (max-width: 767.98px){ .brand-subtitle { font-size: 0.80rem; line-height: 1.3; } }

    #loading-spinner{ position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.7); backdrop-filter: blur(2px); -webkit-backdrop-filter: blur(2px); z-index: 10000; }
    #loading-spinner.hidden { display: none; }
    #loading-spinner .spinner{ width: 50px; height: 50px; border: 6px solid #f3f3f3; border-top: 6px solid #5725AE; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    #search{ padding:0.5rem; border-radius:5px; border:1px solid #ccc; background:#fff; width:210px; }
    .search-toggle{ display:flex; align-items:center; gap:8px; }
    .search-icon-btn{ display:none; background:transparent; border:none; padding:5px; cursor:pointer; }
    .search-icon-btn img{ width:30px; height:30px; display:block; }
    @media (max-width:767.98px){
      .search-icon-btn { display:inline-flex; position: relative; left: -5px; top: -10px; }
      .cart-link { position: relative; right: 6px; top: -6px; }
      .cart-link img { width: 32px; height: 32px; }
      .cart-count { font-size: 0.7rem; height: 18px; min-width: 10px; line-height: 14px; right: -13px; top: -7px; padding: 0 4px; }
      #search{ width:0; opacity:0; padding:0.5rem; border-radius:10px; border:1px solid rgba(255,255,255,.35); color:#fff; background:rgba(255,255,255,.14); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); transition: width .25s ease, opacity .2s ease, padding .25s ease, margin-left .25s ease; pointer-events:none; margin-left:0; }
      .search-toggle.open #search{ width:50vw; opacity:1; pointer-events:auto; margin-left:4px; margin-top:-13px; }
      .banner-bar{ gap:8px; }
    }

    .filter-bar{ background:var(--shell); margin-top:1.2px; padding:14px 12px 10px; }
    .filter-grid{ max-width:1200px; margin:0 auto; display:grid; gap:0.75rem; grid-template-columns: repeat(5, minmax(0, 1fr)); }
    .filter-grid select{ width:100%; padding:0.55rem 0.65rem; border-radius:8px; border:1px solid rgba(255,255,255,.3); background:#ffffff; color:#111; box-shadow:0 2px 6px rgba(0,0,0,.06); }
    @media (max-width:1000px){ .filter-grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); } }

    .controls{ display:flex; justify-content:flex-end; align-items:center; gap:0.75rem; margin:0.75rem auto 0; max-width:1200px; padding:0 1rem; flex-wrap:wrap; }
    .grid-toggle{ display:flex; justify-content:flex-end; gap:0.5rem; margin:0; }
    .layout-button{ background:transparent; border:none; padding:0.5rem; border-radius:6px; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:transform .15s ease; }
    .layout-button:active{ transform:scale(0.96); }
    .layout-button img{ width:24px; height:24px; }
    .layout-button.single img{ width:30px; height:30px; }

    .pager{ max-width:1200px; margin: 0.5rem auto 0.75rem; padding: 0 1rem; display:flex; justify-content:center; gap: 6px; align-items:center; flex-wrap:wrap; user-select:none; }
    .pager .pg-btn{ display:inline-flex; align-items:center; justify-content:center; min-width: 40px; height: 40px; padding: 0 10px; border-radius: 10px; border:1px solid rgba(0,0,0,.12); background:#fff; color:#111; font-weight:600; cursor:pointer; transition: transform .12s ease, background .15s ease, opacity .15s ease; position: relative; top: -4px; }
    .pager .pg-btn:hover{ transform: translateY(-3px); }
    .pager .pg-btn[disabled]{ opacity:.45; cursor:not-allowed; transform:none; }
    .pager .pg-btn[data-action="first"], .pager .pg-btn[data-action="prev"], .pager .pg-btn[data-action="next"], .pager .pg-btn[data-action="last"] { font-size: 20px; line-height: 0.9; }
    .pager .pg-label { font-weight: 400; font-size: 0.85rem; line-height: 10px; padding: 0 6px; color: #111; display: inline-block; }
    @media (max-width: 767.98px){ .pager .pg-label { font-size: 0.8rem; line-height: 36px; } .pager{ gap:4px; } .pager .pg-btn{ min-width:36px; height:36px; border-radius:9px; } }

    .card-container{ display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:1.5rem; max-width:1200px; margin:1.25rem auto 2rem; padding:0 1rem; transition:all .3s ease; }
    .card-container.grid-1{ grid-template-columns:repeat(1,1fr); }
    .card-container.grid-2{ grid-template-columns:repeat(2,1fr); }
    .card-container.grid-3{ grid-template-columns:repeat(3,1fr); }

    .card{ position:relative; background:#fff; border-radius:10px; box-shadow:0 4px 10px rgba(0,0,0,.08); overflow:hidden; display:flex; flex-direction:column; padding:1rem; text-align:center; }
    .card img{ width:100%; aspect-ratio:4/3; object-fit:contain; margin-bottom:0.5rem; border-radius:5px; cursor:zoom-in; }
    .title-block{ min-height:calc(2 * 1.2em + 3 * 1.3em); }
    .card-title{ font-size:clamp(1.05rem, 1.2vw + .9rem, 1.20rem); margin:0.25rem 0; line-height:1.2; display:-webkit-box; -webkit-box-orient:vertical; -webkit-line-clamp:1; overflow:hidden; min-height:1.2em; overflow-wrap:anywhere; word-break:break-word; }
    @media (max-width:767.98px){ .card-title{ -webkit-line-clamp:2; font-size:clamp(.95rem, 4.6vw, 1.10rem); } }
    .series-name{ font-size:0.75rem; color:#555; margin:0.2rem 0 0.6rem; font-style:italic; display:-webkit-box; -webkit-box-orient:vertical; -webkit-line-clamp:3; overflow:hidden; line-height:1.3; min-height:calc(3 * 1.3em); }
    .card-info{ min-height: calc(4 * (1.3em + 0.5rem)); display:flex; flex-direction:column; justify-content:flex-start; }
    .price,.rarity,.condition,.stock{ font-size:0.88rem; line-height:1.3; margin:0.25rem 0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .badge{ position:absolute; top:0.5rem; left:0.5rem; padding:5px 10px; font-size:0.75rem; font-weight:bold; border-radius:4px; z-index:2; text-transform:uppercase; box-shadow:0 2px 5px rgba(0,0,0,.2); line-height:1; }
    .badge.sale{ background:#e02424; color:#fff; }
    .badge.popular{ background:#ffcc00; color:#000; }
    .badge.new{ background:#2fbf71; color:#f8f9fb; }
    .badge.last{ background:#1D1D1C; color:#FF8800; }
    .product-actions{ margin-top:auto; }
    button{ margin-top:0.5rem; padding:0.5rem 1rem; background:#2b6cb0; color:#fff; border:none; border-radius:5px; cursor:pointer; transition:opacity .2s, transform .15s; }
    .container-panel{ max-width:1200px; margin:0 auto 2rem; padding:0 0 1rem; background:#fff; border-radius:12px; box-shadow:0 8px 20px rgba(0,0,0,.05); }

    @media (max-width:767.98px){ .controls{ justify-content:flex-end; } .grid-toggle{ gap:0.15rem !important; } .grid-toggle > .layout-button{ padding:0.25rem !important; margin:0 !important; } .grid-toggle > .layout-button img{ width:22px; height:22px; } .layout-button.triple{ display:none; } }
    @media (min-width:768px){ .layout-button.single{ display:none; } }
    .product-actions button[disabled], button[disabled]{ background:#cbd5e1 !important; color:#6b7280 !important; cursor:not-allowed !important; pointer-events:none; box-shadow:none !important; transform:none !important; opacity:1 !important; }

    #toast { display:none; position:fixed; bottom:10px; right:10px; background:#e31996; color:#f5f5f5; padding:10px 15px; border-radius:5px; z-index:1000; opacity:0; transition:opacity 0.5s ease; }
    #toast.show { display:block; opacity:1; }

    .status-line{ margin:.15rem 0 0; font-size:.85rem; font-weight:600; color:#1f25de; }
    .status-line.oos{ color:#b91c1c; }
    .status-line.hold{ color:#FF9447; }
    .mc-note{ margin-left:6px; font-weight:600; font-size:.85rem; }
    .mc-note.hold{ color:#FF9447; }
    .mc-note.oos{  color:#b91c1c; }
    .reserved-note{ color:#1f25de; font-size:.9em; white-space:nowrap; margin-left:4px; }
    @media (max-width:600px){ .reserved-note{ display:block; margin:2px 0 0 0; font-size:0.75rem; } }

    /* (Quickview, Mini-cart, Scroll-to-top CSS unchanged; keeping for brevity) */
    /* ... keep all your existing CSS here ... */

  </style>
</head>
<body>

  <!-- ===== Overlay Banner Header ===== -->
  <div class="site-shell">
    <div class="shell-pad">
      <div class="hero">
        <div class="banner-bar">
          <!-- Search (left) -->
          <div class="search-toggle" id="searchToggle">
            <button type="button" class="search-icon-btn" id="searchBtn" aria-label="Open search">
              <img src="assets/images/search icon.svg" alt="Search" />
            </button>
            <input type="text" id="search" placeholder="Search for a product..." oninput="applyFilters()" />
          </div>

          <!-- Cart (right) -->
          <div class="cart-wrap">
            <a class="cart-link" href="#" aria-label="Cart" id="cartLink">
              <img src="assets/images/cart%20icon.svg" alt="Cart" />
              <span class="cart-count" id="cartCount">0</span>
            </a>

            <!-- Mini Cart Dropdown -->
            <div id="miniCart" class="mini-cart" role="dialog" aria-modal="false" aria-labelledby="mcTitle" aria-hidden="true">
              <div class="mc-head">
                <strong id="mcTitle">Your Items</strong>
                <button type="button" class="mc-close" aria-label="Close">Ã—</button>
              </div>
              <div class="mc-items" id="mcItems"></div>
              <div class="mc-foot">
                <div class="mc-sub">
                  <span>Subtotal</span>
                  <strong id="mcSubtotal">$0.00</strong>
                </div>
                <div class="mc-actions">
                  <button type="button" class="btn btn--danger" id="mcClear">Clear Cart</button>
                  <button type="button" class="mc-view" id="mcView">View Cart</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Brand in the middle -->
        <div class="brand-center">
          <div>
            <h1 class="brand-title">BreezyEzyTCG</h1>
            <p class="brand-subtitle"><strong>A Collectibles Store With Personality (ï¼ Â´ãƒ¼`)ï¾‰ï¾ž</strong></p>
          </div>
        </div>
      </div>
    </div>

    <!-- Filter selects under the banner -->
    <div class="filter-bar">
      <div class="filter-grid">
        <select id="category-filter" onchange="onCategoryChange()">
          <option value="all">All Categories</option>
        </select>
        <select id="subcategory-filter" onchange="applyFilters()">
          <option value="all">All Subcategories</option>
        </select>
        <select id="rarity-filter" onchange="applyFilters()">
          <option value="all">All Rarity</option>
        </select>
        <select id="condition-filter" onchange="applyFilters()">
          <option value="all">All Conditions</option>
        </select>
        <select id="language-filter" onchange="applyFilters()">
          <option value="all">All Languages</option>
        </select>
      </div>
    </div>
  </div>

  <!-- ===== Content Panel (grid toggle + cards) ===== -->
  <div class="container-panel">
    <div class="controls">
      <div class="grid-toggle">
        <button class="layout-button single" type="button" onclick="setGridView(1)" aria-label="Single column">
          <img alt="Single grid" />
        </button>
        <button class="layout-button double active" type="button" onclick="setGridView(2)" aria-label="Two columns">
          <img alt="Two grid" />
        </button>
        <button class="layout-button triple" type="button" onclick="setGridView(3)" aria-label="Three columns">
          <img alt="Three grid" />
        </button>
      </div>
    </div>

    <nav id="pagerTop" class="pager" aria-label="Pagination (top)"></nav>
    <div class="card-container grid-2"></div>
    <nav id="pagerBottom" class="pager" aria-label="Pagination (bottom)"></nav>
  </div>

  <!-- ===== Quickview Modal ===== -->
  <div class="qv-backdrop" id="qvBackdrop" aria-hidden="true">
    <div class="qv-modal" role="dialog" aria-modal="true" aria-labelledby="qvTitle">
      <div class="qv-header">
        <h3 class="qv-title" id="qvTitle"></h3>
        <button class="qv-close" type="button" aria-label="Close">&times;</button>
      </div>
      <div class="qv-body">
        <section class="qv-gallery">
          <div class="qv-main" id="qvMain">
            <img id="qvImage" alt="Product image" />
            <div class="qv-nav">
              <button type="button" class="qv-arrow" id="qvPrev" aria-label="Previous">
                <img id="qvPrevImg" alt="" />
              </button>
              <button type="button" class="qv-arrow" id="qvNext" aria-label="Next">
                <img id="qvNextImg" alt="" />
              </button>
            </div>
          </div>
          <div class="qv-thumbs" id="qvThumbs"></div>
        </section>

        <section class="qv-info">
          <div class="qv-meta">
            <p class="qv-price" id="qvPrice"></p>
            <p id="qvSeries"><small></small></p>
            <p id="qvRarity"></p>
            <p id="qvCondition"></p>
            <p id="qvStock"></p>
            <div class="qv-descwrap">
              <strong class="qv-desclabel">Description</strong>
              <p class="qv-desc" id="qvDesc"></p>
            </div>
          </div>
          <div class="qv-cta">
            <button id="qvAdd" type="button">Add to Cart</button>
          </div>
          <span class="qv-sr-only" id="qvFocusStart" tabindex="0"></span>
          <span class="qv-sr-only" id="qvFocusEnd" tabindex="0"></span>
        </section>
      </div>
    </div>
  </div>

  <div id="toast"></div>

  <script>
/* ================= SAFETY HELPERS ================= */

/** Treat any text as plain text (blocks hidden HTML/JS). */
function esc(s){
  return String(s ?? '')
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;')
    .replace(/'/g,'&#39;');
}

/** Allow only http(s) or data: for images. Reject javascript: or other schemes. */
function safeImg(url){
  const u = String(url || '').trim();
  if (!u) return '';
  const low = u.toLowerCase();
  if (low.startsWith('javascript:')) return '';
  // Most of your images are https or lh3 googleusercontent; allow data: too.
  if (low.startsWith('http://') || low.startsWith('https://') || low.startsWith('data:')) return u;
  return '';
}

function showSpinner(){ document.getElementById('loading-spinner')?.classList.remove('hidden'); }
function hideSpinner(){ document.getElementById('loading-spinner')?.classList.add('hidden'); }

/* === Toast now uses TEXT ONLY (no HTML injection risk) === */
let toastHideTimer = null;
function showToast(msg, duration = 4000) {
  const toast = document.getElementById("toast");
  toast.textContent = String(msg ?? ''); // SAFE: plain text
  toast.style.display = "block";
  toast.classList.remove("show");
  void toast.offsetWidth;
  toast.classList.add("show");
  if (toastHideTimer) clearTimeout(toastHideTimer);
  toastHideTimer = setTimeout(() => {
    toast.classList.remove("show");
    const done = (e) => {
      if (e.propertyName === "opacity" && !toast.classList.contains("show")) {
        toast.style.display = "none";
        toast.removeEventListener("transitionend", done);
      }
    };
    toast.addEventListener("transitionend", done);
  }, duration);
}

/* ================= YOUR ORIGINAL JS (HARDENED) ================= */

let allProducts = [];

const url = 'https://script.google.com/macros/s/AKfycbxXkVLXwPwvEwj6X_ugCQmGJz9HcGyKxsJG2KSMkO9UthlmjNI2hMPlbB8ksr9sX4I/exec' + '?ts=' + Date.now();

const ALL = 'all';
const state = { kw:'', category:ALL, subcategory:ALL, rarity:ALL, condition:ALL, language:ALL, inStockOnly:true };

const $cat  = document.getElementById('category-filter');
const $sub  = document.getElementById('subcategory-filter');
const $rar  = document.getElementById('rarity-filter');
const $con  = document.getElementById('condition-filter');
const $kw   = document.getElementById('search');
const $lang = document.getElementById('language-filter');

function isAvailable(p){ return Number(p?.stock || 0) > 0; }

function passes(p){
  if (state.inStockOnly && !isAvailable(p)) return false;
  if (state.category   !== ALL && (p.category||'')    !== state.category) return false;
  if (state.subcategory!== ALL && (p.subcategory||'') !== state.subcategory) return false;
  if (state.rarity     !== ALL && (p.rarity||'')      !== state.rarity) return false;
  if (state.condition  !== ALL && (p.condition||'')   !== state.condition) return false;
  if (state.language   !== ALL && (p.language||'')    !== state.language)  return false;
  if (state.kw){
    const blob = `${p.name||''} ${p['series name']||''} ${p.rarity||''} ${p.condition||''}`.toLowerCase();
    if (!blob.includes(state.kw)) return false;
  }
  return true;
}

function buildFacetCounts(products, facetKey){
  const saved = state[facetKey];
  state[facetKey] = ALL;
  const counts = new Map();
  for (const p of products){
    if (!passes(p)) continue;
    const v = (p[facetKey] || '').trim() || '(Unknown)';
    counts.set(v, (counts.get(v) || 0) + 1);
  }
  state[facetKey] = saved;
  return counts;
}

function fillSelect(selectEl, counts, currentValue, allLabel){
  const frag = document.createDocumentFragment();
  const optAll = document.createElement('option');
  optAll.value = ALL; optAll.textContent = allLabel;
  frag.appendChild(optAll);

  const sorted = Array.from(counts.entries())
    .sort((a,b) => a[0].localeCompare(b[0], undefined, {numeric:true, sensitivity:'base'}));

  for (const [val, cnt] of sorted){
    const o = document.createElement('option');
    o.value = val;
    o.textContent = val;
    if (cnt <= 0) o.disabled = true;
    frag.appendChild(o);
  }

  selectEl.innerHTML = '';
  selectEl.appendChild(frag);

  if (currentValue !== ALL && selectEl.querySelector(`option[value="${CSS.escape(currentValue)}"]`)){
    selectEl.value = currentValue;
  } else {
    selectEl.value = ALL;
  }
}

function updateAllFacetOptions(){
  const products = allProducts;
  fillSelect($cat,  buildFacetCounts(products,'category'),    state.category,    'All Categories');
  fillSelect($sub,  buildFacetCounts(products,'subcategory'), state.subcategory, 'All Subcategories');
  fillSelect($rar,  buildFacetCounts(products,'rarity'),      state.rarity,      'All Rarity');
  fillSelect($con,  buildFacetCounts(products,'condition'),   state.condition,   'All Conditions');
  fillSelect($lang, buildFacetCounts(products,'language'),    state.language,    'All Languages');
}

const SFX_PATH = 'assets/audio/PokÃ©mon RedBlueYellow - PC Turning On - Sound Effect.mp3';
const sfx = new Audio(encodeURI(SFX_PATH)); sfx.preload = 'auto'; sfx.volume = 0.6;

const ADD_SFX_PATH = 'assets/audio/add to cart.mp3';
const addSfx = new Audio(encodeURI(ADD_SFX_PATH)); addSfx.preload = 'auto'; addSfx.volume = 0.6;

function playAddSfx(){ try { const node = addSfx.cloneNode(); node.volume = addSfx.volume; const p = node.play(); if (p && typeof p.catch === 'function') p.catch(()=>{}); } catch(e){} }
function playSfx(){ try { sfx.currentTime = 0; sfx.play(); } catch(e){} }

const SHEET_API = "https://script.google.com/macros/s/AKfycbxXkVLXwPwvEwj6X_ugCQmGJz9HcGyKxsJG2KSMkO9UthlmjNI2hMPlbB8ksr9sX4I/exec";
const REFRESH_MS = Number(new URLSearchParams(location.search).get('refresh')) || 60_000;
function isMobile(){ return window.matchMedia("(max-width: 767.98px)").matches; }

function prettyRelease(s){
  if (!s) return '';
  if (/^\d{4}-\d{2}-\d{2}T/.test(s)) {
    const d = new Date(s);
    if (!isNaN(d)) return d.toLocaleDateString(undefined, { year:'numeric', month:'long', day:'numeric' });
  }
  const m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if (m) {
    const d = new Date(+m[1], +m[2]-1, +m[3]);
    if (!isNaN(d)) return d.toLocaleDateString(undefined, { year:'numeric', month:'long', day:'numeric' });
  }
  return s;
}

function safeNumber(val, fb=0){
  if (typeof val === "number" && Number.isFinite(val)) return val;
  const n = parseFloat(val);
  return Number.isFinite(n) ? n : fb;
}

/* === Keys / Cart === */
const _norm = v => String(v ?? '').trim().toLowerCase();
function makeKey({ name, series, rarity, condition, category, subcategory }) {
  return [_norm(name), _norm(series), _norm(rarity), _norm(condition), _norm(category), _norm(subcategory)].join('||');
}
function makeKeyOld({ name, series, rarity, condition }) {
  return [_norm(name), _norm(series), _norm(rarity), _norm(condition)].join('||');
}
function normalizeCart(arr){
  return arr.map(i => {
    const obj = { ...i };
    obj.category    = obj.category    ?? '';
    obj.subcategory = obj.subcategory ?? '';
    const hasNewShape = (obj.key && obj.key.split('||').length >= 6);
    if (!hasNewShape) {
      obj.key = makeKey({
        name: obj.name, series: obj.series, rarity: obj.rarity, condition: obj.condition,
        category: obj.category, subcategory: obj.subcategory
      });
    }
    return obj;
  });
}
function reconcileCartWithInventory(allProducts){
  const byNew = new Map(), byOld = new Map();
  for (const p of allProducts) {
    const kNew = makeKey({ name:p.name, series:p["series name"], rarity:p.rarity, condition:p.condition, category:p.category, subcategory:p.subcategory });
    byNew.set(kNew, p);
    const kOld = makeKeyOld({ name:p.name, series:p["series name"], rarity:p.rarity, condition:p.condition });
    if (!byOld.has(kOld)) byOld.set(kOld, p);
  }
  let cart = getCart(), changed = false, hadOOS = false;
  cart = cart.map(item => {
    const prod = byNew.get(item.key) || byOld.get(item.key);
    if(!prod){ changed = true; hadOOS = true; return { ...item, stock: 0, _oos: true }; }
    const max = Number(prod.stock || 0);
    if (max <= 0){ changed = true; hadOOS = true; return { ...item, stock: 0, _oos: true }; }
    const qty = Math.min(Number(item.quantity || 1), max);
    const upgradedKey = makeKey({ name:prod.name, series:prod["series name"], rarity:prod.rarity, condition:prod.condition, category:prod.category, subcategory:prod.subcategory });
    if (qty !== item.quantity || item.stock !== max || item.key !== upgradedKey) changed = true;
    return { ...item, key:upgradedKey, category:item.category ?? prod.category ?? '', subcategory:item.subcategory ?? prod.subcategory ?? '', stock:max, quantity:qty, _oos:false };
  });
  if (changed){ localStorage.setItem("cart", JSON.stringify(cart)); updateCartCount(); }
  return { changed, hadOOS };
}
function getStatusParts(p){
  const available = safeNumber(p.stock, 0);
  const reserved  = safeNumber(p.reserved, 0);
  const backend   = String(p.status_label || '').trim();
  const reservedNote = (reserved > 0 && available > 0)
    ? ` <span class="reserved-note">(ðŸ”¥${reserved} in checkout now)</span>` : '';
  let statusHTML = '';
  if (available <= 0){
    const txt = backend || 'Out of stock';
    const cls = backend ? 'hold' : 'oos';
    statusHTML = `<p class="status-line ${cls}">${esc(txt)}</p>`;
  }
  const btnLabel = (available > 0) ? 'Add to Cart' : (reserved > 0 ? 'On Hold' : 'Out of Stock');
  return { available, reserved, reservedNote, statusHTML, btnLabel };
}
function findProductForCartItem(item){
  return allProducts.find(p =>
    makeKey({ name:p.name, series:p['series name'], rarity:p.rarity, condition:p.condition, category:p.category, subcategory:p.subcategory }) === item.key
  );
}
function getCart(){
  try{ const raw = JSON.parse(localStorage.getItem("cart") || "[]"); return normalizeCart(Array.isArray(raw) ? raw : []); }
  catch{ return []; }
}
function getCartCount(){ return getCart().reduce((sum, i) => sum + safeNumber(i.quantity,0), 0); }
function updateCartCount(){
  let el = document.getElementById("cartCount");
  if (!el) { el = document.querySelector('.cart-link .cart-count'); if (!el) return; }
  el.textContent = String(getCartCount());
}

/* === Add to Cart (now wired via data-attributes; no inline JS needed) === */
function addToCartFromButton(btn){
  const d = btn.dataset;
  const name = d.name || 'Item';
  const price = safeNumber(d.price, 0);
  const img = d.img || '';
  const series = d.series || '';
  const rarity = d.rarity || '';
  const condition = d.condition || '';
  const stock = safeNumber(d.stock, 0);
  const category = d.category || '';
  const subcat = d.subcategory || '';

  const key = makeKey({ name, series, rarity, condition, category, subcategory: subcat });
  const fresh = allProducts.find(p => makeKey({
    name:p.name, series:p["series name"], rarity:p.rarity, condition:p.condition, category:p.category, subcategory:p.subcategory
  }) === key);
  const max = Number(fresh?.stock ?? stock ?? 0);
  if (max <= 0){ showToast("Sorry, this item is out of stock."); return; }

  const cart = getCart();
  const found = cart.find(i => i.key === key);
  if (found){
    const cur = Number(found.quantity) || 0;
    if (cur >= max){ showToast(`Max available is ${max}.`); return; }
    found.quantity = cur + 1;
    if (typeof found.stock === 'undefined' || found.stock !== max) found.stock = max;
  } else {
    cart.push({
      key, name, series, rarity, condition, category, subcategory: subcat,
      price, quantity:1, image: img, stock: max
    });
  }
  localStorage.setItem("cart", JSON.stringify(cart));
  updateCartCount();
  if (typeof renderMiniCart === 'function') renderMiniCart();
  playAddSfx();
  showToast(`${name} is now in your PC!`);
}

/* === Mini Cart === */
const mc = { wrap:null, dropdown:null, items:null, subtotal:null, viewBtn:null, clearBtn:null, closeBtn:null };
function getCartTotal(){ return getCart().reduce((s,i)=> s + safeNumber(i.price,0)*safeNumber(i.quantity,0), 0); }
function setQty(key, qty){
  const cart = getCart(); const it = cart.find(i => i.key === key); if(!it) return;
  it.quantity = Math.max(1, safeNumber(qty,1));
  localStorage.setItem("cart", JSON.stringify(cart));
  updateCartCount(); renderMiniCart();
}
function incQty(key){
  const cart = getCart(); const it = cart.find(i=>i.key===key); if(!it) return;
  const max = Number(it.stock ?? Infinity), cur = Number(it.quantity) || 0;
  if (cur >= max){ showToast(`Max available is ${isFinite(max) ? max : 0}.`); return; }
  it.quantity = cur + 1; localStorage.setItem("cart", JSON.stringify(cart));
  updateCartCount(); renderMiniCart();
}
function decQty(key){
  const cart = getCart(); const it = cart.find(i=>i.key===key); if(!it) return;
  it.quantity = Math.max(1, it.quantity-1); localStorage.setItem("cart", JSON.stringify(cart));
  updateCartCount(); renderMiniCart();
}
function removeFromCart(key){
  const cart = getCart().filter(i => i.key !== key);
  localStorage.setItem("cart", JSON.stringify(cart));
  updateCartCount(); renderMiniCart();
}
function renderMiniCart(){
  if(!mc.dropdown) return;
  const cart = getCart();
  mc.items.innerHTML = "";

  if(cart.length === 0){
    mc.items.textContent = "Your cart is empty.";
  } else {
    cart.forEach(({key, name, price, quantity, image, _oos, stock}) => {
      const prod  = findProductForCartItem({ key });
      const parts = prod ? getStatusParts(prod) : { available: stock|0, reserved:0, reservedNote:'', statusHTML:'', btnLabel:'' };

      // backend/status label must be escaped
      let miniNoteHTML = '';
      if (parts.available <= 0) {
        if (prod?.status_label) {
          const safeLabel = esc(String(prod.status_label));
          miniNoteHTML = ` <span class="mc-note ${parts.reserved > 0 ? 'hold' : 'oos'}">${safeLabel}</span>`;
        } else {
          miniNoteHTML = ` <span class="mc-note oos">Out of stock</span>`;
        }
      } else if (parts.reserved > 0) {
        miniNoteHTML = ` <span class="mc-note">${parts.reservedNote.replace('reserved-note','')}</span>`;
      }

      const row = document.createElement("div");
      row.className = "mc-item" + ((_oos || Number(stock||0) <= 0) ? " mc-oos" : "");
      const safeKey = String(key).replace(/'/g,"\\'");
      row.innerHTML = `
        <div class="mc-thumb"><img src="${esc(safeImg(image||''))}" alt=""></div>
        <div class="mc-meta">
          <p class="mc-name" title="${esc(name||'')}">${esc(name||'')}</p>
          <p class="mc-price">$${safeNumber(price,0).toFixed(2)}${miniNoteHTML}</p>
          <div class="mc-qty">
            <img src="assets/images/minus%20button.svg" alt="Decrease" onclick="decQty('${safeKey}')" />
            <span>${safeNumber(quantity,1)}</span>
            <img src="assets/images/plus%20button.svg" alt="Increase" onclick="incQty('${safeKey}')" />
          </div>
        </div>
        <button class="mc-remove" aria-label="Remove item" onclick="removeFromCart('${safeKey}')">
          <img src="assets/images/bin.svg" alt="">
        </button>
        <div style="font-weight:600;">$${(safeNumber(price,0)*safeNumber(quantity,1)).toFixed(2)}</div>
      `;
      if ((_oos || Number(stock||0) <= 0)){
        row.querySelectorAll('.mc-qty img').forEach(el => {
          el.setAttribute('aria-disabled','true'); el.style.pointerEvents = 'none'; el.style.opacity = '0.4';
        });
      }
      mc.items.appendChild(row);
    });
  }
  mc.subtotal.textContent = `$${getCartTotal().toFixed(2)}`;
}
function openMiniCart(){ if(!mc.dropdown) return; mc.dropdown.classList.add("open"); mc.dropdown.setAttribute("aria-hidden", "false"); }
function closeMiniCart(){ if(!mc.dropdown) return; mc.dropdown.classList.remove("open"); mc.dropdown.setAttribute("aria-hidden", "true"); }
function toggleMiniCart(){ if(!mc.dropdown) return; const o = mc.dropdown.classList.contains("open"); if(o) closeMiniCart(); else { renderMiniCart(); openMiniCart(); } }
function setupMiniCart(){
  mc.wrap = document.querySelector(".cart-wrap");
  mc.dropdown = document.getElementById("miniCart");
  if(!mc.wrap || !mc.dropdown) return;

  mc.items = document.getElementById("mcItems");
  mc.subtotal = document.getElementById("mcSubtotal");
  mc.viewBtn = document.getElementById("mcView");
  mc.clearBtn = document.getElementById("mcClear");
  mc.closeBtn = mc.dropdown.querySelector(".mc-close");

  mc.closeBtn?.addEventListener("click", closeMiniCart);
  mc.viewBtn?.addEventListener("click", () => { window.location.href = "cart.html"; });
  mc.clearBtn?.addEventListener("click", () => { localStorage.removeItem("cart"); updateCartCount(); renderMiniCart(); });
  mc.dropdown.addEventListener("click", (e) => e.stopPropagation());
  mc.dropdown.addEventListener("touchstart", (e) => e.stopPropagation(), {passive:true});
  document.addEventListener("click", (e) => {
    if (!mc.dropdown.classList.contains("open")) return;
    if (e.target.closest("#miniCart") || e.target.closest("#cartLink")) return;
    const path = e.composedPath ? e.composedPath() : null;
    if (path && (path.includes(mc.dropdown) || path.includes(mc.wrap))) return;
    closeMiniCart();
  });
  document.addEventListener("keydown", (e)=>{ if(e.key === "Escape" && mc.dropdown.classList.contains("open")) closeMiniCart(); });
}

/* ===== Inventory fetch & render ===== */
function byUniqueSorted(arr){
  const map = new Map();
  arr.forEach(v => {
    const s = String(v || '').trim(); if (!s) return;
    const key = s.toLocaleLowerCase(); if (!map.has(key)) map.set(key, s);
  });
  return [...map.values()].sort((a, b) => a.localeCompare(b, undefined, { sensitivity: 'base' }));
}

async function fetchInventoryFromSheet(){
  showSpinner();
  try {
    const res = await fetch(SHEET_API, { cache: 'no-store' });
    const ct = (res.headers.get('content-type') || '').toLowerCase();
    if (!res.ok) throw new Error(`Inventory fetch failed: HTTP ${res.status}`);
    if (!ct.includes('application/json')) throw new Error('API did not return JSON');

    let rows = await res.json();
    if (!Array.isArray(rows) && rows && Array.isArray(rows.data)) rows = rows.data;
    if (!Array.isArray(rows)) throw new Error('JSON payload is not an array');

    allProducts = rows.map(src => {
      const obj = {};
      for (const [k, v] of Object.entries(src)) {
        const key = String(k).trim().toLowerCase();
        obj[key] = (key === 'price' || key === 'stock') ? safeNumber(v) : String(v ?? '').trim();
      }
      if (obj['sub-category'] && !obj.subcategory) obj.subcategory = obj['sub-category'];
      if (obj['image url'] && !obj.image_url)       obj.image_url  = obj['image url'];
      if (obj.lang && !obj.language) obj.language = obj.lang;

      obj.name           = obj.name           || '';
      obj.category       = obj.category       || '';
      obj.subcategory    = obj.subcategory    || '';
      obj.description    = obj.description    || '';
      obj.condition      = obj.condition      || '';
      obj['series name'] = obj['series name'] || '';
      obj.back           = obj.back           || '';
      obj.img2           = obj.img2           || '';
      obj.img3           = obj.img3           || '';
      obj.language       = obj.language       || '';
      obj.price          = safeNumber(obj.price, 0);
      obj.stock          = safeNumber(obj.stock, 0);
      obj.reserved       = safeNumber(src.Reserved ?? src.reserved ?? 0, 0);
      obj.status_label   = String(src.StatusLabel ?? src.statuslabel ?? obj.status_label ?? '');
      return obj;
    });

    initFacets();
    filteredProducts = allProducts.slice();
    paging.page = 1;
    renderPage();
  } catch (err) {
    const c = document.querySelector('.card-container');
    if (c) {
      c.innerHTML = `
        <div style="background:#fff;padding:14px;border-radius:10px">
          <p><strong>Error loading store inventory.</strong></p>
          <p style="color:#555;font-size:.9rem">Details: ${esc(String(err?.message || err))}</p>
        </div>`;
    }
  } finally {
    hideSpinner();
  }
}

function getBadgeInfo(raw){
  if(!raw) return null;
  const t = String(raw).trim().toLowerCase();
  if (["sale","sales"].includes(t)) return { cls:"sale", label:"SALE" };
  if (t === "new") return { cls:"new", label:"NEW" };
  if (["popular","hot"].includes(t)) return { cls:"popular", label:"POPULAR" };
  if (t === "last") return { cls:"last", label:"LAST ONE" };
  return null;
}

/* === RENDER: now uses esc() and safeImg(), and NO inline onclick === */
function renderStore(list){
  const container = document.querySelector(".card-container");
  container.innerHTML = "";

  list.forEach((p) => {
    const available   = safeNumber(p.stock, 0);
    const reserved    = safeNumber(p.reserved, 0);
    const statusLabel = esc(String(p.status_label || "").trim()); // SANITIZED
    const price       = safeNumber(p.price, 0);
    const out         = available <= 0;

    const badge = getBadgeInfo(p.badge);

    // Button label
    let btnLabel = out ? (reserved > 0 ? "On Hold" : "Out of Stock") : "Add to Cart";

    // Inline stock note (sanitized)
    let stockNote = "";
    if (reserved > 0 && available > 0) {
      stockNote = ` <span class="reserved-note" style="font-size:0.75rem; color:#2563eb; font-weight:500;">(ðŸ”¥${reserved} in checkout now)</span>`;
    } else if (reserved > 0 && available <= 0) {
      stockNote = ` <span class="reserved-note" style="font-size:0.75rem; color:#2563eb; font-weight:500;">(${statusLabel || "On hold â€” last unit in checkout"})</span>`;
    }

    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      ${badge ? `<div class="badge ${esc(badge.cls)}">${esc(badge.label)}</div>` : ``}
      <img src="${esc(safeImg(p.image_url || ""))}" alt="${esc(p.name || "Card")}" />
      <div class="title-block">
        <h3 class="card-title">${esc(p.name || "")}</h3>
        <p class="series-name">${esc(p["series name"] || "")}</p>
      </div>
      <div class="card-info">
        <p class="price">$${price.toFixed(2)}</p>
        <p class="rarity"><strong>Rarity:</strong> ${esc(p.rarity || "")}</p>
        <p class="condition"><strong>Condition:</strong> ${esc(p.condition || "")}</p>
        <p class="stock"><strong>Stock:</strong> ${available}${stockNote}</p>
      </div>
      <div class="product-actions">
        <button type="button" class="btn-add"
          ${out ? 'disabled aria-disabled="true" tabindex="-1"' : ''}
          data-name="${esc(p.name || 'Item')}"
          data-price="${price}"
          data-img="${esc(safeImg(p.image_url || ''))}"
          data-series="${esc(p['series name'] || '')}"
          data-rarity="${esc(p.rarity || '')}"
          data-condition="${esc(p.condition || '')}"
          data-stock="${available}"
          data-category="${esc(p.category || '')}"
          data-subcategory="${esc(p.subcategory || '')}"
        >${esc(btnLabel)}</button>
      </div>
    `;
    container.appendChild(card);
  });
}

/* === Event delegation for Add-to-Cart buttons (no inline JS) === */
document.addEventListener('click', (e) => {
  const btn = e.target.closest('.btn-add');
  if (btn) addToCartFromButton(btn);
});

/* ---------- Facets & Paging ---------- */
function applyFilters(){
  state.kw          = ($kw.value || '').toLowerCase();
  state.category    = $cat.value;
  state.subcategory = $sub.value;
  state.rarity      = $rar.value;
  state.condition   = $con.value;
  state.language    = $lang.value;

  filteredProducts = allProducts.filter(passes);
  paging.page = 1; renderPage();
  updateAllFacetOptions();
}
function initFacets(){ updateAllFacetOptions(); }
function onCategoryChange(){ state.category = $cat.value; applyFilters(); }

const ICONS = {
  1: { active: "assets/images/single grid.svg",  inactive: "assets/images/inactive single grid.svg" },
  2: { active: "assets/images/2 grid view.svg",  inactive: "assets/images/inactive 2 grid view.svg" },
  3: { active: "assets/images/3 grid view.svg",  inactive: "assets/images/inactive 3 grid view.svg" }
};
function setToggleIcons(activeType){
  document.querySelectorAll(".layout-button").forEach(btn => {
    let t = btn.classList.contains("single") ? 1 : btn.classList.contains("double") ? 2 : 3;
    const img = btn.querySelector("img"); if (!img) return;
    const path = (t === activeType) ? ICONS[t].active : ICONS[t].inactive;
    img.src = path; img.alt = (t===1 ? "Single" : t===2 ? "Two" : "Three") + " grid";
  });
}
function activateButton(type){
  document.querySelectorAll(".layout-button").forEach(b => b.classList.remove("active"));
  if(type === 1) document.querySelector(".layout-button.single")?.classList.add("active");
  if(type === 2) document.querySelector(".layout-button.double")?.classList.add("active");
  if(type === 3) document.querySelector(".layout-button.triple")?.classList.add("active");
  setToggleIcons(type);
}
function setGridView(type){
  if(isMobile() && type === 3) return;
  if(!isMobile() && type === 1) return;
  const cont = document.querySelector(".card-container");
  cont.classList.remove("grid-1","grid-2","grid-3");
  cont.classList.add(`grid-${type}`);
  activateButton(type);
  applyFilters();
}
function enforceResponsiveGrid(){
  const cont = document.querySelector(".card-container");
  if(isMobile() && cont.classList.contains("grid-3")) setGridView(2);
  else if(!isMobile() && cont.classList.contains("grid-1")) setGridView(2);
}

/* === Title auto-fit (unchanged) === */
function fitCardTitles(root = document){
  const titles = root.querySelectorAll('.card-title');
  titles.forEach(el => {
    el.style.fontSize = '';
    const style = getComputedStyle(el);
    const clamp = parseInt(style.getPropertyValue('-webkit-line-clamp') || '2', 10);
    const maxH = parseFloat(style.lineHeight) * clamp;
    el.style.maxHeight = maxH + 'px';
    let current = parseFloat(style.fontSize); const floor = 12;
    while ((el.scrollHeight > el.clientHeight || el.scrollWidth > el.clientWidth) && current > floor){
      current -= 0.5; el.style.fontSize = current + 'px';
    }
  });
}
let __lastRendered = [];
const __renderOriginal = renderStore;
renderStore = function(list){
  __lastRendered = list.slice();
  __renderOriginal(list);
  requestAnimationFrame(() => fitCardTitles(document));
};
function getCurrentRenderedList(){ return __lastRendered; }

/* === Paging === */
let filteredProducts = [];
let paging = { page: 1 };
function perPage(){ return isMobile() ? 12 : 18; }
function totalPages(){ return Math.max(1, Math.ceil(filteredProducts.length / perPage())); }
function clampPage(p){ return Math.min(Math.max(p, 1), totalPages()); }
function renderPagers(){
  const top = document.getElementById('pagerTop');
  const bottom = document.getElementById('pagerBottom');
  if(!top || !bottom) return;

  const p = paging.page, t = totalPages();
  const btn = (label, disabled, on, title) =>
    `<button type="button" class="pg-btn" ${disabled?'disabled':''} title="${esc(title)}" data-action="${esc(on)}">${esc(label)}</button>`;
  const html = `
    ${btn('Â«', p===1, 'first', 'First page')}
    ${btn('â€¹', p===1, 'prev',  'Previous page')}
    <span class="pg-label">Page ${p} of ${t}</span>
    ${btn('â€º', p===t, 'next',  'Next page')}
    ${btn('Â»', p===t, 'last',  'Last page')}
  `;
  top.innerHTML = html; bottom.innerHTML = html;

  const wire = (root) => root.querySelectorAll('.pg-btn:not([disabled])')
    .forEach(el => el.addEventListener('click', () => {
      const act = el.getAttribute('data-action');
      if(act === 'first') paging.page = 1;
      if(act === 'prev')  paging.page = clampPage(paging.page - 1);
      if(act === 'next')  paging.page = clampPage(paging.page + 1);
      if(act === 'last')  paging.page = totalPages();
      renderPage();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }));

  wire(top); wire(bottom);
}
function renderPage(){
  const start = (paging.page - 1) * perPage();
  const pageItems = filteredProducts.slice(start, start + perPage());
  renderStore(pageItems);
  renderPagers();
}

/* ================== QUICKVIEW ================== */
/* (unchanged logic, but sanitize where needed) */
const MIN_ZOOM = 1, PREFERRED_ZOOM = 1.7, MAX_ZOOM = 4;
let isPanning = false, movedSincePointerDown = false, lastTapTime = 0;
const DOUBLE_TAP_MS = 280;

const qv = {
  open:false, index:0, images:[], product:null,
  backdrop:null, modal:null, title:null, price:null, series:null, rarity:null, condition:null, stock:null, desc:null,
  main:null, img:null, thumbs:null, prev:null, next:null, addBtn:null, closeBtn:null,
  zoom:{ scale: MIN_ZOOM, levels:[MIN_ZOOM, PREFERRED_ZOOM, 2.5, 3.5] }
};
function buildImagesArray(p){
  const arr = [p.image_url, p.back, p.img2, p.img3].filter(Boolean).map(safeImg).filter(Boolean);
  return [...new Set(arr)];
}
const lightLeft  = "assets/images/arrow-button-left-2-svgrepo-com.svg";
const lightRight = "assets/images/arrow-button-right-2-svgrepo-com.svg";
const darkLeft   = "assets/images/white-arrow-button-left-2-svgrepo-com.svg";
const darkRight  = "assets/images/white-arrow-button-right-2-svgrepo-com.svg";
function applyArrowTheme(){
  const isDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
  const prevImg = document.getElementById("qvPrevImg");
  const nextImg = document.getElementById("qvNextImg");
  if(prevImg) prevImg.src = isDark ? darkLeft : lightLeft;
  if(nextImg) nextImg.src = isDark ? darkRight : lightRight;
}
function setupQuickview(){
  qv.backdrop = document.getElementById('qvBackdrop');
  qv.modal    = qv.backdrop.querySelector('.qv-modal');
  qv.title    = document.getElementById('qvTitle');
  qv.price    = document.getElementById('qvPrice');
  qv.series   = document.getElementById('qvSeries').querySelector('small');
  qv.rarity   = document.getElementById('qvRarity');
  qv.condition= document.getElementById('qvCondition');
  qv.stock    = document.getElementById('qvStock');
  qv.desc     = document.getElementById('qvDesc');
  qv.main     = document.getElementById('qvMain');
  qv.img      = document.getElementById('qvImage');
  qv.thumbs   = document.getElementById('qvThumbs');
  qv.prev     = document.getElementById('qvPrev');
  qv.next     = document.getElementById('qvNext');
  qv.addBtn   = document.getElementById('qvAdd');
  qv.closeBtn = qv.backdrop.querySelector('.qv-close');

  qv.img.setAttribute('draggable', 'false');
  qv.img.addEventListener('dragstart', e => e.preventDefault());

  applyArrowTheme();
  const mql = window.matchMedia("(prefers-color-scheme: dark)");
  if (mql.addEventListener) mql.addEventListener("change", applyArrowTheme);
  else if (mql.addListener) mql.addListener(applyArrowTheme);

  qv.closeBtn.addEventListener('click', closeQuickview);
  qv.backdrop.addEventListener('click', (e)=>{ if(e.target === qv.backdrop) closeQuickview(); });
  document.addEventListener('keydown', (e)=>{
    if(!qv.open) return;
    if(e.key === 'Escape') closeQuickview();
    if(e.key === 'ArrowLeft') showSlide(qv.index - 1);
    if(e.key === 'ArrowRight') showSlide(qv.index + 1);
  });

  // (gesture/zoom handlers unchanged â€“ omitted for brevity)

  qv._resetToFit = function(){
    qv.img.style.transform = `translate(0px,0px) scale(${MIN_ZOOM})`;
    qv.main.classList.remove('zoomed');
  };
}
function getField(p, keys){
  for (const k of keys){
    const v = p?.[k] ?? p?.[k.toLowerCase?.() || k];
    if (v != null && String(v).trim() !== '') return String(v).trim();
  }
  return '';
}
function openQuickview(product){
  qv.product = product;
  qv.images  = buildImagesArray(product);
  qv.index   = 0;

  qv.title.textContent     = product.name || '';
  qv.price.textContent     = Number.isFinite(product.price) ? `$${Number(product.price).toFixed(2)}` : '';
  qv.series.textContent    = product['series name'] || '';
  qv.rarity.textContent    = product.rarity    ? `Rarity: ${product.rarity}`       : '';
  qv.condition.textContent = product.condition ? `Condition: ${product.condition}` : '';

  const available = safeNumber(product.stock, 0);
  const reserved  = safeNumber(product.reserved, 0);
  let stockHTML   = Number.isFinite(available) ? `<strong>Stock:</strong> ${available}` : '';
  if (reserved > 0 && available > 0) stockHTML += ` <span class="reserved-note">(ðŸ”¥${reserved} in checkout now)</span>`;
  else if (available <= 0 && reserved > 0) stockHTML += ` <span class="reserved-note">(last unit in checkout)</span>`;
  qv.stock.innerHTML = stockHTML;

  const illustrator = getField(product, ['Illustrated By','illustrated by',"Illustrator's Name","illustrator's name",'illustrator']);
  const releaseRaw  = getField(product, ['Release Date','release date','set release date']);
  const releasePretty = prettyRelease(releaseRaw);
  const cardNo      = getField(product, ['Card #','card #','card no','card no.']);

  const lines = [];
  if (illustrator) lines.push(`<strong>Illustrated By:</strong> ${esc(illustrator)}`);
  if (releasePretty) lines.push(`<strong>Set Release Date/Year:</strong> ${esc(releasePretty)}`);
  if (cardNo) lines.push(`<strong>Card #:</strong> ${esc(cardNo)}`);

  const desc   = (product.description || '').trim();
  const descHtml = desc ? esc(desc).replace(/\n/g, '<br>') : '';
  const combined = [lines.join('<br>'), descHtml].filter(Boolean).join('<br><br>');
  document.getElementById('qvDesc').innerHTML = combined || '-';

  const isOut = available <= 0;
  const btnLabel = isOut ? (reserved > 0 ? 'On Hold' : 'Out of Stock') : 'Add to Cart';
  qv.addBtn.textContent = btnLabel;
  qv.addBtn.disabled    = isOut;
  qv.addBtn.onclick = isOut ? null : () =>
    addToCartFromButton({
      dataset: {
        name: product.name || 'Item',
        price: String(safeNumber(product.price,0)),
        img: safeImg(product.image_url || ''),
        series: product['series name'] || '',
        rarity: product.rarity || '',
        condition: product.condition || '',
        stock: String(available),
        category: product.category || '',
        subcategory: product.subcategory || ''
      }
    });

  qv.thumbs.innerHTML = '';
  qv.images.forEach((src, i) => {
    const t = document.createElement('button');
    t.type = 'button';
    t.className = 'qv-thumb' + (i === 0 ? ' active' : '');
    t.innerHTML = `<img src="${esc(src)}" alt="thumbnail ${i+1}">`;
    t.addEventListener('click', (e) => { e.stopPropagation(); showSlide(i); });
    qv.thumbs.appendChild(t);
  });

  showSlide(0);
  qv._resetToFit && qv._resetToFit();
  qv.backdrop.classList.add('open');
  qv.backdrop.setAttribute('aria-hidden', 'false');
  qv.open = true;
  document.body.style.overflow = 'hidden';
  qv.closeBtn.focus();
}
function closeQuickview(){
  qv.open = false;
  qv.backdrop.classList.remove('open');
  qv.backdrop.setAttribute('aria-hidden','true');
  document.body.style.overflow='';
  qv._resetToFit && qv._resetToFit();
}
function showSlide(i){
  if(qv.images.length === 0) return;
  if(i < 0) i = qv.images.length - 1;
  if(i >= qv.images.length) i = 0;
  qv.index = i;
  qv.img.src = qv.images[i];
  qv._resetToFit && qv._resetToFit();
  [...qv.thumbs.children].forEach((el, idx)=> el.classList.toggle('active', idx===i));
}
function attachImageClickDelegation(){
  const container = document.querySelector('.card-container');
  if(!container) return;
  container.addEventListener('click', (e)=>{
    const img = e.target.closest('img');
    if(!img || !container.contains(img)) return;
    const cards = [...container.querySelectorAll('.card img')];
    const clickIndex = cards.indexOf(img);
    const renderedList = getCurrentRenderedList();
    const chosen = renderedList[clickIndex];
    if(chosen) openQuickview(chosen);
  });
}

/* ===== UI wiring ===== */
function applyArrowThemeOnLoad(){ applyArrowTheme(); }
window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").addEventListener?.("change", applyArrowThemeOnLoad);
window.addEventListener("storage", (e) => { if (e.key === "cart") updateCartCount(); });
window.addEventListener("resize", () => { enforceResponsiveGrid(); paging.page = clampPage(paging.page); renderPage(); });
window.addEventListener("orientationchange", () => { enforceResponsiveGrid(); paging.page = clampPage(paging.page); renderPage(); });

/* --- Mobile search toggle --- */
(function(){
  const toggle = document.getElementById('searchToggle');
  const btn = document.getElementById('searchBtn');
  const input = document.getElementById('search');
  if(!toggle || !btn || !input) return;

  btn.addEventListener('click', (e)=>{
    e.stopPropagation();
    toggle.classList.toggle('open');
    if (toggle.classList.contains('open')) {
      setTimeout(()=> input.focus(), 150);
    }
  });
  document.addEventListener('click', (e)=>{
    if (!toggle.classList.contains('open')) return;
    if (!toggle.contains(e.target)) toggle.classList.remove('open');
  });
  document.addEventListener('keydown', (e)=>{
    if (e.key === 'Escape' && toggle.classList.contains('open')) {
      toggle.classList.remove('open');
      input.blur();
    }
  });
})();

/* Cart icon: play sfx + toggle dropdown (no redirect) */
(() => {
  const cartBtn = document.getElementById('cartLink');
  if(!cartBtn) return;
  cartBtn.addEventListener('click', (e)=>{
    e.preventDefault();
    playSfx();
    toggleMiniCart();
  });
})();

/* ===== Refresh loop with reconciliation ===== */
updateCartCount();
fetchInventoryFromSheet();
setupQuickview();
attachImageClickDelegation();
setToggleIcons(2);
setupMiniCart();

async function refreshInventoryPreserveFilters(){
  const saved = {
    kw:  document.getElementById("search").value,
    cat: document.getElementById("category-filter").value,
    sub: document.getElementById("subcategory-filter").value,
    rar: document.getElementById("rarity-filter").value,
    con: document.getElementById("condition-filter").value,
  };
  const pageBefore = paging.page;
  await fetchInventoryFromSheet();

  const rec = reconcileCartWithInventory(allProducts);
  if (rec.changed) {
    updateCartCount();
    renderMiniCart();
    if (rec.hadOOS){ showToast(`Aiyo.. Some items in your cart have changed. Go take a quick look!`); }
  }

  state.kw          = (saved.kw || '').toLowerCase();
  state.category    = saved.cat;
  state.subcategory = saved.sub;
  state.rarity      = saved.rar;
  state.condition   = saved.con;

  document.getElementById("search").value              = saved.kw;
  document.getElementById("category-filter").value     = saved.cat;
  document.getElementById("subcategory-filter").value  = saved.sub;
  document.getElementById("rarity-filter").value       = saved.rar;
  document.getElementById("condition-filter").value    = saved.con;

  applyFilters();
  paging.page = clampPage(pageBefore);
  renderPage();
}
let refreshTimer = setInterval(refreshInventoryPreserveFilters, REFRESH_MS);
document.addEventListener('visibilitychange', () => {
  if (document.hidden) { clearInterval(refreshTimer); }
  else { refreshInventoryPreserveFilters(); refreshTimer = setInterval(refreshInventoryPreserveFilters, REFRESH_MS); }
});

/* === Scroll-to-top button logic === */
document.addEventListener('DOMContentLoaded', () => {
  const scrollBtn = document.getElementById('scrollTopBtn');
  if (!scrollBtn) return;
  let scrollTimeout;
  const toggleBtn = () => { if (window.scrollY > 300) scrollBtn.classList.add('show'); else scrollBtn.classList.remove('show'); };
  window.addEventListener('scroll', () => {
    toggleBtn();
    if (scrollBtn.classList.contains('show')) {
      scrollBtn.classList.add('scrolling');
      clearTimeout(scrollTimeout);
      scrollTimeout = setTimeout(() => { scrollBtn.classList.remove('scrolling'); }, 200);
    }
  }, { passive: true });
  toggleBtn();
  scrollBtn.addEventListener('click', () => { requestAnimationFrame(() => { window.scrollTo({ top: 0, behavior: 'smooth' }); }); });
});
  </script>

  <!-- Scroll to Top Button -->
  <button id="scrollTopBtn" type="button" aria-label="Scroll to top">
    <img src="assets/images/return to top.svg" alt="Back to top" />
  </button>

  <!-- Loading Spinner -->
  <div id="loading-spinner" class="hidden">
    <div class="spinner"></div>
  </div>

</body>
</html>
